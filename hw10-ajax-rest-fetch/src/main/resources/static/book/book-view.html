<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Book</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">Book Library</a>
            <div class="navbar-nav">
                <a class="nav-link" href="/books.html">Books</a>
                <a class="nav-link" href="/authors.html">Authors</a>
                <a class="nav-link" href="/genres.html">Genres</a>
            </div>
        </div>
    </nav>

    <div id="book"></div>

    <h3>Comments</h3>
    <form id="commentForm">
        <textarea id="text" required></textarea>
        <button>Add Comment</button>
    </form>
    <div id="comments"></div>

    <script>
        const bookId = new URLSearchParams(location.search).get('id');

        Promise.all([
            fetch(`/api/v1/books/${bookId}`).then(r => r.json()),
            fetch(`/api/v1/comments/book/${bookId}`).then(r => r.json())
        ]).then(([book, comments]) => {
            document.getElementById('book').innerHTML = `
                <h2>${book.title}</h2>
                <p>Author: ${book.author.fullName}</p>
                <p>Genre: ${book.genre.name}</p>
                <button onclick="location.href='/book-edit.html?id=${book.id}'">Edit</button>
                <button onclick="fetch('/api/v1/books/${book.id}',{method:'DELETE'}).then(()=>location.href='/')">Delete</button>
            `;
            document.getElementById('comments').innerHTML =
                comments.map(c => `
                    <div>
                        ${c.text}
                        <button onclick="fetch('/api/v1/comments/${c.id}',{method:'DELETE'}).then(()=>location.reload())">Delete</button>
                    </div>
                `).join('') || 'No comments';
        });

        document.getElementById('commentForm').onsubmit = async (e) => {
            e.preventDefault();
            await fetch('/api/v1/comments', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({
                    text: document.getElementById('text').value,
                    bookId: bookId
                })
            });
            location.reload();
        };
    </script>
</body>
</html>